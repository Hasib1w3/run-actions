name: Keep Spaces Alive

# ------------------------------------------------------------------------------
# REQUIRED GITHUB SECRETS
# ------------------------------------------------------------------------------
# Please create the following Repository Secrets in GitHub (Settings -> Secrets):
# 1. HF_TOKEN_HASIBXX2X
# 2. HF_TOKEN_TBHRTGJNR
# 3. HF_TOKEN_BDFBEFBH
# 4. HF_TOKEN_HTYJY6
# 5. HF_TOKEN_MUHAMMAD
# ------------------------------------------------------------------------------

on:
  schedule:
    - cron: "0 */10 * * *" # Every 10 hours
  workflow_dispatch:

jobs:
  ping_spaces:
    runs-on: ubuntu-latest
    steps:
      - name: Run Health and Action Checks
        env:
          # Map Secrets to Env Vars for Shell Access
          TOKEN_HASIB: ${{ secrets.HF_TOKEN_HASIBXX2X }}
          TOKEN_TBHR: ${{ secrets.HF_TOKEN_TBHRTGJNR }}
          TOKEN_GEMINI: ${{ secrets.HF_TOKEN_BDFBEFBH }}
          TOKEN_CLONE: ${{ secrets.HF_TOKEN_HTYJY6 }}
          TOKEN_INSPIRE: ${{ secrets.HF_TOKEN_MUHAMMAD }}

          # List of URL|ENV_VAR_NAME
          URLS: >
            https://hasibxx2x-api.hf.space/health|TOKEN_HASIB
            https://hasibxx2x-api1.hf.space/health|TOKEN_HASIB
            https://hasibxx2x-api2.hf.space/health|TOKEN_HASIB
            https://hasibxx2x-api3.hf.space/health|TOKEN_HASIB
            https://hasibxx2x-api4.hf.space/health|TOKEN_HASIB
            https://hasibxx2x-api5.hf.space/health|TOKEN_HASIB
            https://hasibxx2x-api6.hf.space/health|TOKEN_HASIB
            https://hasibxx2x-api7.hf.space/health|TOKEN_HASIB
            https://hasibxx2x-api8.hf.space/health|TOKEN_HASIB
            https://tbhrtgjnr-api.hf.space/health|TOKEN_TBHR
            https://tbhrtgjnr-api1.hf.space/health|TOKEN_TBHR
            https://tbhrtgjnr-api2.hf.space/health|TOKEN_TBHR
            https://tbhrtgjnr-api3.hf.space/health|TOKEN_TBHR
            https://tbhrtgjnr-api4.hf.space/health|TOKEN_TBHR
            https://tbhrtgjnr-api5.hf.space/health|TOKEN_TBHR
            https://tbhrtgjnr-api6.hf.space/health|TOKEN_TBHR
            https://tbhrtgjnr-api7.hf.space/health|TOKEN_TBHR
            https://tbhrtgjnr-api8.hf.space/health|TOKEN_TBHR
            https://bdfbefbh-gemini.hf.space/health|TOKEN_GEMINI
            https://bdfbefbh-gemini1.hf.space/health|TOKEN_GEMINI
            https://bdfbefbh-gemini2.hf.space/health|TOKEN_GEMINI
            https://bdfbefbh-gemini3.hf.space/health|TOKEN_GEMINI
            https://bdfbefbh-gemini4.hf.space/health|TOKEN_GEMINI
            https://bdfbefbh-gemini5.hf.space/health|TOKEN_GEMINI
            https://bdfbefbh-gemini6.hf.space/health|TOKEN_GEMINI
            https://bdfbefbh-gemini7.hf.space/health|TOKEN_GEMINI
            https://bdfbefbh-gemini8.hf.space/health|TOKEN_GEMINI
            https://htyjy6-siteclone.hf.space/health|TOKEN_CLONE
            https://htyjy6-siteclone1.hf.space/health|TOKEN_CLONE
            https://htyjy6-siteclone2.hf.space/health|TOKEN_CLONE
            https://htyjy6-siteclone3.hf.space/health|TOKEN_CLONE
            https://htyjy6-siteclone4.hf.space/health|TOKEN_CLONE
            https://htyjy6-siteclone5.hf.space/health|TOKEN_CLONE
            https://htyjy6-siteclone6.hf.space/health|TOKEN_CLONE
            https://htyjy6-siteclone7.hf.space/health|TOKEN_CLONE
            https://htyjy6-siteclone8.hf.space/health|TOKEN_CLONE
            https://muhammadshahalamsheikh-inspiration.hf.space/health|TOKEN_INSPIRE
            https://muhammadshahalamsheikh-inspiration1.hf.space/health|TOKEN_INSPIRE
            https://muhammadshahalamsheikh-inspiration2.hf.space/health|TOKEN_INSPIRE
            https://muhammadshahalamsheikh-inspiration3.hf.space/health|TOKEN_INSPIRE
            https://muhammadshahalamsheikh-inspiration4.hf.space/health|TOKEN_INSPIRE
            https://muhammadshahalamsheikh-inspiration5.hf.space/health|TOKEN_INSPIRE
            https://muhammadshahalamsheikh-inspiration6.hf.space/health|TOKEN_INSPIRE
            https://muhammadshahalamsheikh-inspiration7.hf.space/health|TOKEN_INSPIRE
            https://muhammadshahalamsheikh-inspiration8.hf.space/health|TOKEN_INSPIRE
          
          # POST Config using indirect variables
          POST_CONFIG: |
            https://bdfbefbh-gemini.hf.space/generate|TOKEN_GEMINI
            {
              "user_prompt": "hi",
              "system_prompt": "keep-alive check",
              "config": "api"
            }
            https://bdfbefbh-gemini1.hf.space/generate|TOKEN_GEMINI
            {
              "user_prompt": "hi",
              "system_prompt": "keep-alive check",
              "config": "auto"
            }
            https://bdfbefbh-gemini2.hf.space/generate|TOKEN_GEMINI
            {
              "user_prompt": "hi",
              "system_prompt": "keep-alive check",
              "config": "auto"
            }
            https://bdfbefbh-gemini3.hf.space/generate|TOKEN_GEMINI
            {
              "user_prompt": "hi",
              "system_prompt": "keep-alive check",
              "config": "auto"
            }
            https://bdfbefbh-gemini4.hf.space/generate|TOKEN_GEMINI
            {
              "user_prompt": "hi",
              "system_prompt": "keep-alive check",
              "config": "auto"
            }
            https://bdfbefbh-gemini5.hf.space/generate|TOKEN_GEMINI
            {
              "user_prompt": "hi",
              "system_prompt": "keep-alive check",
              "config": "auto"
            }
            https://bdfbefbh-gemini6.hf.space/generate|TOKEN_GEMINI
            {
              "user_prompt": "hi",
              "system_prompt": "keep-alive check",
              "config": "auto"
            }
            https://bdfbefbh-gemini7.hf.space/generate|TOKEN_GEMINI
            {
              "user_prompt": "hi",
              "system_prompt": "keep-alive check",
              "config": "auto"
            }
            https://bdfbefbh-gemini8.hf.space/generate|TOKEN_GEMINI
            {
              "user_prompt": "hi",
              "system_prompt": "keep-alive check",
              "config": "auto"
            }
        
        run: |
          # --- Helper to resolve env var by name ---
          get_token() {
            var_name=$1
            # indirect expansion using bash syntax (works in ubuntu-latest)
            echo "${!var_name}"
          }

          echo "Starting Health Checks (GET)..."
          
          # Iterate GET URLs
          for entry in $URLS; do
            url="${entry%|*}"
            token_var="${entry#*|}"
            token=$(get_token "$token_var")

            echo "GET: $url (Using $token_var)"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 -H "Authorization: Bearer $token" "$url")
            
            if [ "$STATUS" -eq 200 ] || [ "$STATUS" -eq 405 ] || [ "$STATUS" -eq 401 ]; then 
               # 200 OK. 405/401 implies alive but maybe method/path mismatch which confirms 'alive'.
               echo "✅ OK ($STATUS)"
            else
               echo "⚠️ Status: $STATUS"
            fi
            echo "---"
          done

          echo "Starting Generation Checks (POST)..."
          
          CURRENT_URL=""
          CURRENT_TOKEN_VAR=""
          JSON_BUFFER=""
          
          execute_post() {
            if [ -n "$CURRENT_URL" ]; then
              token=$(get_token "$CURRENT_TOKEN_VAR")
              echo "POST: $CURRENT_URL (Using $CURRENT_TOKEN_VAR)"
              
              echo "$JSON_BUFFER" > post.json
              
              # Wait Max 240 seconds (4 minutes)
              STATUS=$(curl -s -o resp.txt -w "%{http_code}" -X POST -H "Content-Type: application/json" -H "Authorization: Bearer $token" -d @post.json --max-time 240 "$CURRENT_URL")
              
              if [ "$STATUS" -eq 200 ]; then
                 echo "✅ OK (200)"
              else
                 echo "⚠️ Status: $STATUS"
              fi
              
              # GATHERING RESPONSE: Print the response from resp.txt
              echo "⬇️ Response:"
              cat resp.txt
              echo "" # Force a new line
              echo "---"
            fi
          }

          while IFS= read -r line || [ -n "$line" ]; do
             clean=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
             if [ -z "$clean" ]; then continue; fi
             
             if [[ "$clean" == http* ]]; then
               execute_post
               CURRENT_URL="${clean%|*}"
               CURRENT_TOKEN_VAR="${clean#*|}"
               JSON_BUFFER=""
             else
               JSON_BUFFER+="$line "
             fi
          done <<< "$POST_CONFIG"
          
          execute_post
