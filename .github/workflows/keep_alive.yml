name: Keep Spaces Alive

on:
  # Schedule to run every 10 hours
  schedule:
    - cron: "0 */10 * * *"
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  ping_spaces:
    runs-on: ubuntu-latest
    steps:
      # --------------------------------------------------------------------------
      # STEP 1: Standard Health Checks (GET Requests)
      # --------------------------------------------------------------------------
      - name: Check Health Endpoints (GET)
        env:
          # Configuration for simple health checks
          URLS: >
            https://hasibxx2x-siteclone.hf.space/health
            https://hasibxx2x-gemini.hf.space/health
            https://hasibxx2x-inspiration.hf.space/health
            https://hasibxx2x-api.hf.space/health
            https://hasibxx2x-api1.hf.space/health
            https://hasibxx2x-api2.hf.space/health
        run: |
          echo "Starting health checks..."
          error_found=0
          
          for url in $URLS; do
            echo "Target: $url"
            # 10 second timeout for health checks
            STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$url")
            
            if [ "$STATUS_CODE" -eq 200 ]; then
              echo "‚úÖ Success (Status: 200)"
            else
              echo "‚ùå Failed (Status: $STATUS_CODE)"
              error_found=1
            fi
            echo "----------------------------------------"
          done

          if [ $error_found -eq 1 ]; then
            echo "‚ö†Ô∏è  One or more spaces failed health checks."
            # We don't exit here so the POST requests below can still run
          fi

      # --------------------------------------------------------------------------
      # STEP 2: POST Requests (Generations/Actions)
      # --------------------------------------------------------------------------
      - name: Run POST Generators
        env:
          # ‚ö† IMPORTANT: Use the pipe symbol '|' below to preserve newlines
          # Format:
          # Link starting with http...
          # { The JSON Body }
          POST_CONFIG: |
            https://hasibxx2x-gemini.hf.space/generate
            {
              "user_prompt": "hi",
              "system_prompt": "helpful assistant¬†",
              "config": "auto"
            }
            
        run: |
          echo "Starting POST requests..."
          
          # Initialize variables
          CURRENT_URL=""
          JSON_BUFFER=""
          ERROR_FOUND=0
          
          # Function to execute the curl command
          execute_post() {
            if [ -n "$CURRENT_URL" ]; then
              echo "üëâ Triggering: $CURRENT_URL"
              
              # Write JSON buffer to a temp file to handle quotes safely
              echo "$JSON_BUFFER" > post_body.json
              
              # Execute Curl
              # -X POST: Post request
              # -d @post_body.json: Send data from file
              # --max-time 480: Hard timeout of 8 minutes
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -H "Content-Type: application/json" \
                -X POST \
                -d @post_body.json \
                --max-time 480 \
                "$CURRENT_URL")

              if [ "$STATUS_CODE" -eq 200 ]; then
                echo "‚úÖ Request finished (Status: 200)"
              else
                echo "‚ùå Request failed or timed out (Status: $STATUS_CODE)"
                echo "   (If status is 000, it likely hit the 8-minute limit)"
                ERROR_FOUND=1
              fi
              echo "----------------------------------------"
            fi
          }

          # Loop through the environment variable line by line
          while IFS= read -r line || [ -n "$line" ]; do
            # Trim leading/trailing whitespace
            clean_line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            
            # Skip empty lines
            if [ -z "$clean_line" ]; then continue; fi

            # If line starts with http, it is a new request
            if [[ "$clean_line" == http* ]]; then
              # 1. Execute the previous request (if one exists)
              execute_post
              
              # 2. Reset buffers for the new request
              CURRENT_URL="$clean_line"
              JSON_BUFFER=""
            else
              # It is part of the JSON body
              JSON_BUFFER+="$line "
            fi
          done <<< "$POST_CONFIG"

          # Execute the very last request in the list
          execute_post

          if [ $ERROR_FOUND -eq 1 ]; then
            echo "‚ö†Ô∏è Some POST requests failed."
            exit 1
          else
            echo "üéâ All requests completed successfully."
          fi
