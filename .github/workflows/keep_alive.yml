name: Keep Spaces Alive

on:
  schedule:
    - cron: "0 */10 * * *" # Every 10 hours
  workflow_dispatch:

jobs:
  ping_spaces:
    runs-on: ubuntu-latest
    steps:
      # --------------------------------------------------------------------------
      # STEP 1: Standard Health Checks (GET Requests) with AUTH
      # --------------------------------------------------------------------------
      - name: Check Health Endpoints (GET)
        env:
          # Pull the token from GitHub Secrets
          HF_TOKEN: ${{ secrets.HF_TOKEN }} 
          URLS: >
            https://hasibxx2x-siteclone.hf.space/health
            https://hasibxx2x-siteclone1.hf.space/health
            https://hasibxx2x-siteclone2.hf.space/health
            https://hasibxx2x-inspiration.hf.space/health
            https://hasibxx2x-inspiration1.hf.space/health
            https://hasibxx2x-inspiration2.hf.space/health
            https://hasibxx2x-api.hf.space/health
            https://hasibxx2x-api1.hf.space/health
            https://hasibxx2x-api2.hf.space/health
        run: |
          echo "Starting health checks..."
          error_found=0
          
          if [ -z "$HF_TOKEN" ]; then
            echo "‚ùå Error: HF_TOKEN secret is missing or empty!"
            exit 1
          fi

          for url in $URLS; do
            echo "Target: $url"
            # Added header: -H "Authorization: Bearer $HF_TOKEN"
            STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 10 \
              -H "Authorization: Bearer $HF_TOKEN" \
              "$url")
            
            if [ "$STATUS_CODE" -eq 200 ]; then
              echo "‚úÖ Success (Status: 200)"
            else
              echo "‚ùå Failed (Status: $STATUS_CODE)"
              # Optional: Don't error out entire workflow for just one fail, 
              # just mark variable
              error_found=1
            fi
            echo "----------------------------------------"
          done

      # --------------------------------------------------------------------------
      # STEP 2: POST Requests (Generations/Actions) with AUTH & LOGGING
      # --------------------------------------------------------------------------
      - name: Run POST Generators
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          POST_CONFIG: |
            https://hasibxx2x-gemini.hf.space/generate
            {
              "user_prompt": "hi",
              "system_prompt": "helpful assistant",
              "config": "auto"
            }

            https://hasibxx2x-gemini1.hf.space/generate
            {
              "user_prompt": "hi",
              "system_prompt": "helpful assistant",
              "config": "auto"
            }

            https://hasibxx2x-gemini2.hf.space/generate
            {
              "user_prompt": "hi",
              "system_prompt": "helpful assistant",
              "config": "auto"
            }
            
        run: |
          echo "Starting POST requests..."

          if [ -z "$HF_TOKEN" ]; then
            echo "‚ùå Error: HF_TOKEN secret is missing or empty!"
            exit 1
          fi
          
          CURRENT_URL=""
          JSON_BUFFER=""
          ERROR_FOUND=0
          
          execute_post() {
            if [ -n "$CURRENT_URL" ]; then
              echo "üëâ Triggering: $CURRENT_URL"
              
              # Save JSON payload to file
              echo "$JSON_BUFFER" > post_body.json
              
              # Clear previous response file
              echo "" > response.txt
              
              # Execute Curl with Auth
              # Added: -H "Authorization: Bearer $HF_TOKEN"
              STATUS_CODE=$(curl -s -o response.txt -w "%{http_code}" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $HF_TOKEN" \
                -X POST \
                -d @post_body.json \
                --max-time 480 \
                "$CURRENT_URL")

              if [ "$STATUS_CODE" -eq 200 ]; then
                echo "‚úÖ Request finished (Status: 200)"
                echo "üìÑ API RESPONSE:"
                echo "----------------------------------------"
                cat response.txt
                echo ""
                echo "----------------------------------------"
              else
                echo "‚ùå Request failed (Status: $STATUS_CODE)"
                echo "üìÑ ERROR DETAILS:"
                cat response.txt
                ERROR_FOUND=1
              fi
            fi
          }

          # Read config line by line
          while IFS= read -r line || [ -n "$line" ]; do
            clean_line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            
            if [ -z "$clean_line" ]; then continue; fi

            if [[ "$clean_line" == http* ]]; then
              execute_post
              CURRENT_URL="$clean_line"
              JSON_BUFFER=""
            else
              JSON_BUFFER+="$line "
            fi
          done <<< "$POST_CONFIG"

          # Execute final request
          execute_post

          if [ $ERROR_FOUND -eq 1 ]; then
            echo "‚ö†Ô∏è Some POST requests failed."
            exit 1
          else
            echo "üéâ All requests completed successfully."
          fi
